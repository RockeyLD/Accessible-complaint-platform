<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ— éšœç¢åæ§½å¹³å° - ç»¼åˆç‰ˆ</title>

    <style id="style-landing">
      :root {
        --lp-bg: #f0f4f8;
        --lp-text: #102a43;
        --lp-accent: #0b6e4f;
        --lp-focus: #1c7ed6;
      }
      body {
        margin: 0;
        font-family: "Noto Sans SC", sans-serif;
        background: var(--lp-bg);
      }

      #view-landing {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
      }

      .landing-title {
        font-size: clamp(2rem, 5vw, 3rem);
        margin-bottom: 40px;
        color: var(--lp-text);
      }

      .card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
        max-width: 900px;
      }

      .role-card {
        background: white;
        border: 3px solid transparent;
        border-radius: 20px;
        padding: 40px;
        width: 300px;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .role-card:hover,
      .role-card:focus {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        border-color: var(--lp-accent);
        outline: 4px solid var(--lp-focus);
        outline-offset: 4px;
      }

      .role-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        display: block;
      }
      .role-name {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--lp-text);
      }
      .role-desc {
        color: #555;
        font-size: 1rem;
        line-height: 1.5;
      }

      .back-home-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 9999;
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .back-home-btn:hover,
      .back-home-btn:focus {
        background: #000;
        outline: 3px solid var(--lp-focus);
      }

      .hidden-view {
        display: none !important;
      }
    </style>

    <style id="style-hearing" disabled>
      :root {
        --bg-1: #fef6e4;
        --bg-2: #dff4ef;
        --ink: #102a43;
        --muted: #5b6b7a;
        --accent: #0b6e4f;
        --accent-2: #f08a24;
        --danger: #d64550;
        --card: #ffffff;
        --focus: #1c7ed6;
        --glow-1: rgba(240, 138, 36, 0.18);
        --glow-2: rgba(11, 110, 79, 0.18);
        --shadow: 0 24px 60px rgba(16, 42, 67, 0.16);
        --radius: 18px;
        --radius-sm: 12px;
        --font-title:
          "Noto Serif SC", "Source Han Serif SC", "STSong", "SimSun", serif;
        --font-body:
          "Noto Sans SC", "Source Han Sans SC", "PingFang SC",
          "Microsoft YaHei", "Heiti SC", sans-serif;
      }

      #view-hearing * {
        box-sizing: border-box;
      }

      #view-hearing {
        font-family: var(--font-body);
        color: var(--ink);
        background:
          radial-gradient(circle at top left, var(--glow-1), transparent 55%),
          radial-gradient(circle at 80% 20%, var(--glow-2), transparent 50%),
          linear-gradient(130deg, var(--bg-1), var(--bg-2));
        min-height: 100vh;
        line-height: 1.6;
        padding-top: 50px;
      }

      body.contrast #view-hearing {
        --bg-1: #ffffff;
        --bg-2: #f2f2f2;
        --ink: #0b0b0b;
        --muted: #2a2a2a;
        --accent: #004f3a;
        --accent-2: #b45309;
        --card: #ffffff;
        --glow-1: rgba(0, 0, 0, 0);
        --glow-2: rgba(0, 0, 0, 0);
      }

      #view-hearing header {
        padding: 40px 24px 12px;
        text-align: center;
      }
      #view-hearing header h1 {
        font-family: var(--font-title);
        font-size: clamp(2rem, 4vw, 3.4rem);
        margin: 0 0 12px;
        letter-spacing: 0.04em;
      }
      #view-hearing header p {
        margin: 0 auto;
        max-width: 760px;
        color: var(--muted);
        font-size: 1.05rem;
      }
      #view-hearing main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 24px 60px;
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }

      .panel {
        background: var(--card);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }
      .panel::before {
        content: "";
        position: absolute;
        width: 160px;
        height: 160px;
        background: rgba(11, 110, 79, 0.08);
        border-radius: 50%;
        top: -60px;
        right: -40px;
      }
      .panel h2 {
        margin: 0 0 12px;
        font-size: 1.4rem;
      }

      .toolbar {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        margin-bottom: 18px;
      }
      .tool {
        background: rgba(11, 110, 79, 0.08);
        border-radius: var(--radius-sm);
        padding: 12px;
      }
      .tool label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .toggle-btn {
        border: 2px solid var(--accent);
        background: transparent;
        color: var(--accent);
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition:
          transform 0.2s ease,
          background 0.2s ease;
      }
      .toggle-btn[aria-pressed="true"] {
        background: var(--accent);
        color: #fff;
      }

      .toggle-btn:focus-visible,
      button:focus-visible,
      input:focus-visible,
      textarea:focus-visible,
      select:focus-visible {
        outline: 3px solid var(--focus);
        outline-offset: 2px;
      }

      .field {
        margin-bottom: 16px;
      }
      .field label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      #view-hearing input[type="text"],
      #view-hearing textarea,
      #view-hearing select {
        width: 100%;
        border-radius: var(--radius-sm);
        border: 2px solid rgba(16, 42, 67, 0.15);
        padding: 10px 12px;
        font-size: 1rem;
        font-family: inherit;
        transition:
          border 0.2s ease,
          box-shadow 0.2s ease;
        background: #fff;
      }
      #view-hearing textarea {
        min-height: 96px;
        resize: vertical;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border: 2px solid rgba(16, 42, 67, 0.2);
        padding: 6px 12px;
        border-radius: 999px;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .chip[aria-pressed="true"] {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(11, 110, 79, 0.08);
      }

      .grid-2 {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      .range-wrap {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .range-wrap input[type="range"] {
        flex: 1;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(240, 138, 36, 0.18);
        font-size: 0.85rem;
        font-weight: 600;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
      }
      button.primary {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }
      button.secondary {
        background: transparent;
        color: var(--accent);
        border: 2px solid var(--accent);
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
      }
      button.ghost {
        background: rgba(16, 42, 67, 0.06);
        color: var(--ink);
        border: none;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        padding: 12px;
        border-radius: var(--radius-sm);
        background: rgba(11, 110, 79, 0.08);
        color: var(--ink);
        font-weight: 600;
        margin-bottom: 12px;
      }
      .status.warn {
        background: rgba(214, 69, 80, 0.12);
        color: var(--danger);
      }
      .status.info {
        background: rgba(240, 138, 36, 0.16);
      }

      .preview-card {
        border: 2px dashed rgba(16, 42, 67, 0.2);
        border-radius: var(--radius-sm);
        padding: 16px;
        background: rgba(255, 255, 255, 0.7);
        min-height: 180px;
      }
      .preview-card h3 {
        margin: 0 0 8px;
      }
      .missing-panel {
        margin-top: 16px;
        padding: 16px;
        border-radius: var(--radius-sm);
        background: rgba(214, 69, 80, 0.08);
      }

      .question {
        margin-bottom: 12px;
      }
      .question input {
        margin-top: 6px;
      }
      .progress-wrap {
        margin: 16px 0 10px;
      }
      .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .progress-bar {
        height: 10px;
        background: rgba(16, 42, 67, 0.1);
        border-radius: 999px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        transition: width 0.3s ease;
      }

      .access-list {
        display: grid;
        gap: 8px;
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
        color: var(--muted);
      }
      .access-list li::before {
        content: "â—";
        color: var(--accent-2);
        margin-right: 8px;
      }
    </style>

    <style id="style-vision" disabled>
      :root {
        /* ä½¿ç”¨è§†éšœåæ§½.html çš„é…è‰²å˜é‡ */
        --v-bg: #f5f3ef;
        --v-bg-2: #efe7dd;
        --v-ink: #141414;
        --v-muted: #3d3d3d;
        --v-accent: #0f5c5c; /* æ·±é’è‰² */
        --v-danger: #a02920;
        --v-card: #ffffff;
        --v-focus: #ffb100; /* é«˜å¯¹æ¯”é»„ */
        --v-shadow: 0 14px 35px rgba(0, 0, 0, 0.12);
      }
      #view-vision * {
        box-sizing: border-box;
      }
      #view-vision {
        font-family: "Source Serif 4", "Noto Serif SC", "Songti SC", serif;
        color: var(--v-ink);
        /* èƒŒæ™¯æ¸å˜ä¿æŒåŸè®¾è®¡ */
        background:
          radial-gradient(
            1200px 600px at 20% -20%,
            #f0d9c7 0%,
            transparent 60%
          ),
          radial-gradient(1000px 500px at 90% 10%, #d9f0ea 0%, transparent 55%),
          linear-gradient(180deg, var(--v-bg), var(--v-bg-2));
        min-height: 100vh;
        padding-top: 50px;
      }

      /* ç»Ÿä¸€é“¾æ¥é¢œè‰² */
      #view-vision a {
        color: var(--v-accent);
      }

      /* ç»Ÿä¸€èšç„¦æ ·å¼ - é»„è‰²é«˜äº® */
      #view-vision a:focus,
      #view-vision button:focus,
      #view-vision input:focus,
      #view-vision textarea:focus,
      #view-vision select:focus {
        outline: 3px solid var(--v-focus);
        outline-offset: 2px;
      }

      .skip-link {
        position: absolute;
        left: -999px;
        top: 10px;
        background: var(--v-card);
        color: var(--v-ink);
        padding: 10px 14px;
        border-radius: 8px;
        box-shadow: var(--v-shadow);
        z-index: 10;
      }
      .skip-link:focus {
        left: 12px;
      }
      #view-vision header {
        padding: 28px 20px 16px;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 20px 60px;
      }
      .brand {
        font-family: "Noto Serif SC", "Source Serif 4", serif;
        letter-spacing: 1px;
        text-transform: uppercase;
        font-size: 12px;
      }
      #view-vision h1 {
        font-size: clamp(28px, 4vw, 48px);
        margin: 10px 0 14px;
      }
      .lead {
        font-size: 18px;
        line-height: 1.6;
        color: var(--v-muted);
      }

      .v-card {
        background: var(--v-card);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--v-shadow);
      }

      #view-vision form {
        display: grid;
        gap: 14px;
      }
      #view-vision label {
        font-weight: 600;
      }

      /* è¾“å…¥æ¡†æ ·å¼ç»Ÿä¸€ */
      #view-vision input,
      #view-vision textarea,
      #view-vision select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #cfcfcf;
        font-size: 16px;
      }
      .input-with-mic {
        position: relative;
      }
      .input-with-mic input,
      .input-with-mic textarea {
        padding-right: 50px;
      }

      /* éº¦å…‹é£æŒ‰é’®æ ·å¼ */
      .mic-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: #f0f0f0;
        color: var(--v-ink);
        border: 0;
        padding: 8px 10px;
        border-radius: 999px;
        cursor: pointer;
      }
      .mic-btn svg {
        display: block;
      }
      #view-vision textarea {
        min-height: 120px;
        resize: vertical;
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      #view-vision fieldset {
        border: 0;
        padding: 0;
        margin: 0;
      }
      #view-vision legend {
        font-weight: 600;
        margin-bottom: 6px;
      }
      #view-vision .help-panel {
        margin: 12px 0;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #cfcfcf;
        background: #fff;
      }
      #view-vision .help-panel strong {
        display: block;
        margin-bottom: 8px;
      }
      #view-vision .help-actions {
        display: flex;
        justify-content: center;
        margin-top: 8px;
      }
      #view-vision .help-mic {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: 0;
        background: var(--v-accent);
        color: #fff;
        cursor: pointer;
      }
      #view-vision .help-mic:focus-visible {
        outline: 3px solid var(--v-focus);
        outline-offset: 2px;
      }
      #view-vision .prompt-box {
        width: 100%;
        min-height: 110px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #cfcfcf;
        background: #f9f7f3;
        color: var(--v-ink);
        resize: none;
      }

      #view-vision .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      /* æäº¤æŒ‰é’®ä½¿ç”¨ Accent è‰² */
      #view-vision .primary-btn {
        background: var(--v-accent);
        color: white;
        border: 0;
        padding: 12px 18px;
        border-radius: 999px;
        font-size: 16px;
        cursor: pointer;
      }
      /* æ¬¡è¦æŒ‰é’® */
      #view-vision .button-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        padding: 12px 18px;
        border-radius: 999px;
        font-size: 16px;
        background: #f0f0f0;
        color: var(--v-ink);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      .note {
        font-size: 14px;
        color: var(--v-muted);
      }
      #view-vision footer {
        margin-top: 50px;
        font-size: 12px;
        color: var(--v-muted);
      }
    </style>
  </head>

  <body>
    <div id="view-landing">
      <h1 class="landing-title">æ¬¢è¿ä½¿ç”¨æ— éšœç¢åæ§½å¹³å°</h1>
      <p class="note" style="margin-bottom: 20px">
        æç¤ºï¼šæ”¯æŒé¼ æ ‡ç‚¹å‡»ã€Tab é”®åˆ‡æ¢ç„¦ç‚¹ã€‚å•å‡»æˆ–å›è½¦è¿›å…¥ã€‚
      </p>
      <div class="card-container">
        <button
          class="role-card"
          onclick="switchMode('hearing')"
          aria-label="æˆ‘æ˜¯å¬éšœç”¨æˆ·ï¼Œè¿›å…¥æ–‡å­—è¾…åŠ©æ¨¡å¼ã€‚å•å‡»è¿›å…¥ã€‚"
        >
          <span class="role-icon" aria-hidden="true">ğŸ§</span>
          <span class="role-name">æˆ‘æ˜¯å¬éšœç”¨æˆ·</span>
          <span class="role-desc"
            >æä¾›æ¸…æ™°çš„æ–‡å­—æç¤ºã€é«˜å¯¹æ¯”åº¦ç•Œé¢ï¼Œä¸ä¾èµ–å£°éŸ³åé¦ˆã€‚</span
          >
        </button>

        <button
          class="role-card"
          onclick="switchMode('vision')"
          aria-label="æˆ‘æ˜¯è§†éšœç”¨æˆ·ï¼Œè¿›å…¥è§†éšœè¾…åŠ©æ¨¡å¼ã€‚å•å‡»è¿›å…¥ã€‚"
        >
          <span class="role-icon" aria-hidden="true">ğŸ‘¨â€ğŸ¦¯</span>
          <span class="role-name">æˆ‘æ˜¯è§†éšœç”¨æˆ·</span>
          <span class="role-desc">æä¾›å¤§å·å­—ä½“ã€æ¸…æ™°å±‚çº§ä¸é”®ç›˜æ“ä½œæ”¯æŒã€‚</span>
        </button>
      </div>
    </div>

    <div id="view-hearing" class="hidden-view">
      <button class="back-home-btn" onclick="switchMode('landing')">
        â† è¿”å›é¦–é¡µ
      </button>
      <header>
        <h1>å¬éšœå‹å¥½ Â· åæ§½å¹³å°</h1>
        <p>
          ç”¨æ¸…æ™°çš„æ–‡å­—è¯´æ¸…æ¥šä½ çš„åæ§½ã€‚å¹³å°ä¸ä¾èµ–å£°éŸ³æç¤ºï¼Œå…¨éƒ¨åé¦ˆéƒ½æœ‰æ˜ç¡®çš„è§†è§‰æé†’ä¸å¯è¯»æ–‡æœ¬ã€‚
        </p>
      </header>
      <main>
        <section class="panel" aria-labelledby="form-title">
          <h2 id="form-title">å†™ä¸‹ä½ çš„åæ§½</h2>
          <div class="toolbar" role="group" aria-label="æ— éšœç¢å·¥å…·">
            <div class="tool">
              <label for="bgTheme">èƒŒæ™¯ä¸»é¢˜</label>
              <select id="bgTheme">
                <option value="warm">æš–æ™¨æ©™ç»¿</option>
                <option value="sea">æµ·é£è“ç»¿</option>
                <option value="sun">æ—¥å…‰ç±³é»„</option>
                <option value="stone">æ¸…çˆ½ç°ç™½</option>
              </select>
            </div>
            <div class="tool">
              <label for="fontSize">æ–‡å­—å¤§å°</label>
              <input
                id="fontSize"
                type="range"
                min="90"
                max="120"
                value="100"
              />
            </div>
            <div class="tool">
              <label>é«˜å¯¹æ¯”</label>
              <button
                class="toggle-btn"
                type="button"
                data-toggle="contrast"
                aria-pressed="false"
              >
                å¼€å¯é«˜å¯¹æ¯”
              </button>
            </div>
          </div>

          <form id="complaintForm" novalidate>
            <div class="field">
              <label>ç±»åˆ«ï¼ˆå¯å¤šé€‰ï¼‰</label>
              <div class="chips" id="categoryChips">
                <button class="chip" type="button" aria-pressed="false">
                  å…¬å…±æœåŠ¡
                </button>
                <button class="chip" type="button" aria-pressed="false">
                  å‡ºè¡Œ
                </button>
                <button class="chip" type="button" aria-pressed="false">
                  åŒ»ç–—
                </button>
                <button class="chip" type="button" aria-pressed="false">
                  æ•™è‚²
                </button>
                <button class="chip" type="button" aria-pressed="false">
                  çº¿ä¸Šå¹³å°
                </button>
                <button class="chip" type="button" aria-pressed="false">
                  å·¥ä½œåœºæ‰€
                </button>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="subject">åæ§½å¯¹è±¡ï¼ˆå¿…å¡«ï¼‰</label>
                <input
                  id="subject"
                  type="text"
                  placeholder="å¦‚ï¼šåœ°é“ç«™æœåŠ¡å° / æŸåº”ç”¨å®¢æœ"
                />
              </div>
              <div class="field">
                <label for="scene">å‘ç”Ÿåœºæ™¯ï¼ˆæ¨èï¼‰</label>
                <input
                  id="scene"
                  type="text"
                  placeholder="å¦‚ï¼šæ—©é«˜å³° / çº¿ä¸Šå’¨è¯¢ / åŒ»é™¢çª—å£"
                />
              </div>
            </div>

            <div class="field">
              <label for="problem">å…·ä½“é—®é¢˜ï¼ˆå¿…å¡«ï¼‰</label>
              <textarea
                id="problem"
                placeholder="é—®é¢˜å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›ä¿¡æ¯æ²¡æœ‰è¢«æ–‡å­—åŒ–ï¼Ÿ"
              ></textarea>
            </div>

            <div class="field">
              <label for="impact">å½±å“äº†ä»€ä¹ˆï¼ˆæ¨èï¼‰</label>
              <textarea
                id="impact"
                placeholder="ä¾‹ï¼šé”™è¿‡æ’é˜Ÿå·ï¼Œæ— æ³•åŠæ—¶åŠç†ä¸šåŠ¡ã€‚"
              ></textarea>
            </div>

            <div class="field">
              <label for="wish">æœŸæœ›çš„æ”¹è¿›ï¼ˆæ¨èï¼‰</label>
              <textarea
                id="wish"
                placeholder="ä¾‹ï¼šæä¾›å±å¹•å®æ—¶å­—å¹•ã€å†™å­—æ¿æˆ–çŸ­ä¿¡æé†’ã€‚"
              ></textarea>
            </div>

            <div class="field">
              <label>æƒ…ç»ªå¼ºåº¦</label>
              <div class="range-wrap">
                <input id="emotion" type="range" min="1" max="5" value="3" />
                <span class="badge" id="emotionLabel">ä¸­ç­‰</span>
              </div>
            </div>

            <div class="progress-wrap">
              <div class="progress-label">
                <span>å¡«å†™è¿›åº¦</span>
                <span id="progressText">0 / 2</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
            </div>

            <div class="actions">
              <button class="primary" type="button" id="buildBtn">
                ç”Ÿæˆåæ§½å¡ç‰‡
              </button>
              <button class="secondary" type="reset">æ¸…ç©ºå†…å®¹</button>
            </div>
          </form>
        </section>

        <section class="panel" aria-labelledby="preview-title">
          <h2 id="preview-title">åæ§½å¡ç‰‡é¢„è§ˆ</h2>
          <div
            class="status info"
            id="statusBox"
            role="status"
            aria-live="polite"
          >
            å¡«å†™å†…å®¹åä¼šåœ¨è¿™é‡Œç”Ÿæˆæ¸…æ™°å¯è¯»çš„åæ§½å¡ç‰‡ã€‚
          </div>
          <div class="preview-card" id="preview">
            <p>å¡«å†™åä¼šç”Ÿæˆä¸€å¥è¯åæ§½ï¼Œæ–¹ä¾¿ç›´æ¥æäº¤ã€‚</p>
          </div>
          <div
            class="missing-panel"
            id="missingPanel"
            hidden
            aria-live="polite"
          ></div>
          <div class="actions">
            <button class="secondary" type="button" id="saveBtn" disabled>
              ä¸Šä¼ åˆ°æœåŠ¡å™¨
            </button>
          </div>
          <ul class="access-list">
            <li>æ‰€æœ‰åé¦ˆå‡ä¸ºæ–‡å­—æç¤ºï¼Œæ— è¯­éŸ³ä¾èµ–ã€‚</li>
            <li>é«˜å¯¹æ¯”ã€å­—å·è°ƒèŠ‚ä¸å‡å°‘åŠ¨ç”»é€‚é…å¬éšœç”¨æˆ·ä¸å¤šæ ·è§†è§‰éœ€æ±‚ã€‚</li>
            <li>ç¼ºå¤±ä¿¡æ¯ä¼šè‡ªåŠ¨è¯¢é—®å¹¶æç¤ºè¡¥å…¨ã€‚</li>
          </ul>
        </section>
      </main>
    </div>

    <div id="view-vision" class="hidden-view">
      <button
        class="back-home-btn"
        onclick="switchMode('landing')"
        aria-label="è¿”å›é¦–é¡µ"
      >
        â† è¿”å›é¦–é¡µ
      </button>
      <header class="wrap">
        <div class="brand">Vision-First</div>
        <h1>ç›´æ¥åæ§½</h1>
        <p class="lead">æŠŠé—®é¢˜è¯´æ¸…æ¥šå°±è¡Œï¼Œè¡¨å•å°½é‡çŸ­ã€‚</p>
        <p class="note">å•å‡»æˆ–æŒ‰ Tab åˆ‡æ¢ç„¦ç‚¹å³å¯æ“ä½œã€‚</p>
      </header>

      <main id="main-vision" class="wrap">
        <section id="submit">
          <div class="v-card">
            <form aria-describedby="form-note">
              <p class="note">ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£ï¼ŒæŒ‰æç¤ºè¡¥å……ä¿¡æ¯ã€‚</p>
              <div class="help-panel" id="visionHelp" hidden>
                <strong>è¡¥å…¨æç¤º</strong>
                <textarea
                  id="visionPromptBox"
                  class="prompt-box"
                  readonly
                  aria-live="polite"
                ></textarea>
                <div class="help-actions">
                  <button
                    class="help-mic"
                    type="button"
                    id="visionHelpMic"
                    aria-label="è¯­éŸ³è¾“å…¥åˆ°è¡¥å……æ¡†"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                    >
                      <path
                        d="M12 15a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v6a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V22h2v-3.08A7 7 0 0 0 19 12h-2Z"
                        fill="currentColor"
                      />
                    </svg>
                  </button>
                </div>
              </div>
              <p class="note">
                æç¤ºï¼šè¯­éŸ³è¾“å…¥éœ€è¦æµè§ˆå™¨æ”¯æŒï¼ˆå»ºè®® https æˆ– localhostï¼‰ã€‚
              </p>

              <div class="actions">
                <button id="v-submitBtn" class="primary-btn" type="button">
                  æäº¤åæ§½
                </button>
                <a class="button-link" href="æŸ¥çœ‹åæ§½.html">åæ§½å¹¿åœº</a>
                <span id="form-note" class="note"
                  >æäº¤åä¼šè‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Šï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚</span
                >
              </div>
              <p class="sr-only" aria-live="polite">
                æç¤ºï¼šæ‰€æœ‰è¾“å…¥é¡¹å‡æ”¯æŒé”®ç›˜è®¿é—®ã€‚
              </p>
              <p
                id="v-status"
                class="note"
                role="status"
                aria-live="polite"
              ></p>
            </form>
          </div>
        </section>
      </main>

      <footer class="wrap">
        <p>æç¤ºï¼šé¡µé¢ä¸ºè§†éšœä¼˜å…ˆåŸå‹ï¼Œæ‰€æœ‰äº¤äº’å…ƒç´ æ”¯æŒé”®ç›˜è®¿é—®ã€‚</p>
      </footer>
    </div>

    <script>
      // --- 0. å…¨å±€çš„çŠ¶æ€ä¸è·¯ç”±æ§åˆ¶ ---
      let currentMode = "landing";

      function switchMode(mode) {
        const landing = document.getElementById("view-landing");
        const hearing = document.getElementById("view-hearing");
        const vision = document.getElementById("view-vision");
        const styleHearing = document.getElementById("style-hearing");
        const styleVision = document.getElementById("style-vision");

        currentMode = mode;

        if (mode === "landing") {
          landing.classList.remove("hidden-view");
          hearing.classList.add("hidden-view");
          vision.classList.add("hidden-view");
          styleHearing.disabled = true;
          styleVision.disabled = true;
          document.title = "æ— éšœç¢åæ§½å¹³å° - é¦–é¡µ";
        } else if (mode === "hearing") {
          landing.classList.add("hidden-view");
          hearing.classList.remove("hidden-view");
          vision.classList.add("hidden-view");
          styleHearing.disabled = false;
          styleVision.disabled = true;
          document.title = "å¬éšœå‹å¥½åæ§½å¹³å°";
          initHearingMode();
        } else if (mode === "vision") {
          landing.classList.add("hidden-view");
          hearing.classList.add("hidden-view");
          vision.classList.remove("hidden-view");
          styleHearing.disabled = true;
          styleVision.disabled = false;
          document.title = "åæ§½å¹¿åœº - è§†éšœæ¨¡å¼";
          initVisionMode();
        }
      }
    </script>

    <script>
      const DEFAULT_API_BASE = "https://complaints-api.ton-ton.fun";
      const API_BASE = localStorage.getItem("apiBase") || DEFAULT_API_BASE;

      function apiUrl(path) {
        if (!API_BASE) return path;
        return `${API_BASE.replace(/\/+$/, "")}${path}`;
      }

      async function postComplaint(payload) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 8000);
        try {
          const headers = { "Content-Type": "application/json" };
          const apiKey = localStorage.getItem("apiKey");
          if (apiKey) headers["X-API-Key"] = apiKey;
          const res = await fetch(apiUrl("/api/complaints"), {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
            signal: controller.signal,
          });
          if (!res.ok) {
            let message = "æäº¤å¤±è´¥";
            try {
              const err = await res.json();
              if (err && err.error) message = err.error;
            } catch (e) {}
            return { ok: false, error: message };
          }
          const data = await res.json().catch(() => ({}));
          return { ok: true, data };
        } catch (err) {
          const message =
            err && err.name === "AbortError" ? "è¯·æ±‚è¶…æ—¶" : "æ— æ³•è¿æ¥åç«¯";
          return { ok: false, error: message };
        } finally {
          clearTimeout(timer);
        }
      }
    </script>

    <script>
      // --- 1. å¬éšœæ¨¡å¼é€»è¾‘ ---
      function initHearingMode() {
        if (window.hearingInitialized) return;
        window.hearingInitialized = true;

        const form = document.getElementById("complaintForm");
        const subject = document.getElementById("subject");
        const scene = document.getElementById("scene");
        const problem = document.getElementById("problem");
        const impact = document.getElementById("impact");
        const wish = document.getElementById("wish");
        const emotion = document.getElementById("emotion");
        const emotionLabel = document.getElementById("emotionLabel");
        const progressText = document.getElementById("progressText");
        const progressFill = document.getElementById("progressFill");
        const preview = document.getElementById("preview");
        const statusBox = document.getElementById("statusBox");
        const missingPanel = document.getElementById("missingPanel");
        const saveBtn = document.getElementById("saveBtn");
        const buildBtn = document.getElementById("buildBtn");
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        const chips = document.querySelectorAll("#categoryChips .chip");
        const fontSize = document.getElementById("fontSize");
        const bgTheme = document.getElementById("bgTheme");

        const state = { categories: new Set() };
        const storeKey = "hearing-complaints";
        const themeKey = "hearing-theme";

        const questionMap = {
          subject: "ä½ åœ¨åæ§½å“ªä¸ªå¯¹è±¡/æœåŠ¡/å¹³å°ï¼Ÿ",
          scene: "å‘ç”Ÿåœºæ™¯ï¼ˆåœ°ç‚¹/æ—¶é—´ï¼Œå¦‚ï¼šåŒ»é™¢çª—å£/æ—©é«˜å³°ï¼‰ï¼Ÿ",
          problem: "å…·ä½“é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿç¼ºå°‘äº†å“ªäº›æ–‡å­—æˆ–è§†è§‰æç¤ºï¼Ÿ",
          impact: "é€ æˆäº†ä»€ä¹ˆå½±å“æˆ–ä¸ä¾¿ï¼Ÿ",
          wish: "ä½ å¸Œæœ›å¯¹æ–¹å¦‚ä½•æ”¹è¿›ï¼Ÿ",
        };
        const detailLabelMap = {
          impact: "å½±å“äº†ä»€ä¹ˆ",
          wish: "æœŸæœ›çš„æ”¹è¿›",
        };
        const detailAnswers = { impact: [], wish: [] };
        const autoFillCache = { impact: "", wish: "" };
        let lastProblemSeed = "";

        const emotionMap = {
          1: "å¾ˆå¹³é™",
          2: "è½»å¾®ä¸æ»¡",
          3: "ä¸­ç­‰",
          4: "æ˜æ˜¾ä¸æ»¡",
          5: "éå¸¸ç”Ÿæ°”",
        };

        const themeMap = {
          warm: {
            bg1: "#fef6e4",
            bg2: "#dff4ef",
            glow1: "rgba(240, 138, 36, 0.18)",
            glow2: "rgba(11, 110, 79, 0.18)",
          },
          sea: {
            bg1: "#e8f3ff",
            bg2: "#d9f7f3",
            glow1: "rgba(59, 130, 246, 0.16)",
            glow2: "rgba(20, 184, 166, 0.18)",
          },
          sun: {
            bg1: "#fff3d6",
            bg2: "#fceee1",
            glow1: "rgba(245, 158, 11, 0.18)",
            glow2: "rgba(251, 191, 36, 0.16)",
          },
          stone: {
            bg1: "#f2f4f8",
            bg2: "#ffffff",
            glow1: "rgba(148, 163, 184, 0.16)",
            glow2: "rgba(100, 116, 139, 0.12)",
          },
        };

        function setStatus(message, type = "info") {
          statusBox.textContent = message;
          statusBox.className = `status ${type}`;
        }

        function applyTheme(key) {
          const theme = themeMap[key] || themeMap.warm;
          const root = document.documentElement.style;
          root.setProperty("--bg-1", theme.bg1);
          root.setProperty("--bg-2", theme.bg2);
          root.setProperty("--glow-1", theme.glow1);
          root.setProperty("--glow-2", theme.glow2);
        }

        function updateEmotionLabel() {
          emotionLabel.textContent = emotionMap[emotion.value];
        }

        function updateProgress() {
          const filled = [subject.value.trim(), problem.value.trim()].filter(
            Boolean,
          ).length;
          progressText.textContent = `${filled} / 2`;
          progressFill.style.width = `${(filled / 2) * 100}%`;
        }

        function collectData() {
          return {
            subject: subject.value.trim(),
            scene: scene.value.trim(),
            problem: problem.value.trim(),
            impact: impact.value.trim(),
            wish: wish.value.trim(),
            emotion: emotionMap[emotion.value],
            emotionValue: emotion.value,
            categories: Array.from(state.categories),
          };
        }

        function buildSentence(data) {
          const parts = [];
          const subjectText = data.subject || "ã€å¾…è¡¥å……ã€‘";
          const problemText = data.problem || "ã€å¾…è¡¥å……ã€‘";
          const sceneText = data.scene ? data.scene.trim() : "";

          let intro = `æˆ‘æƒ³åæ§½${subjectText}`;
          if (sceneText) {
            if (!subjectText.includes(sceneText))
              intro = `åœ¨${sceneText}ï¼Œæˆ‘æƒ³åæ§½${subjectText}`;
          }

          parts.push(intro.trim());
          parts.push(`ä¸»è¦é—®é¢˜æ˜¯${problemText}`);
          if (data.impact) parts.push(`å¯¼è‡´${data.impact}`);
          if (data.wish) parts.push(`å¸Œæœ›${data.wish}`);

          const meta = [];
          if (data.categories.length)
            meta.push(`ç±»åˆ«ï¼š${data.categories.join("ã€")}`);
          meta.push(`æƒ…ç»ªï¼š${data.emotion}`);
          if (meta.length) parts.push(`ï¼ˆ${meta.join("ï¼Œ")}ï¼‰`);

          return `${parts.join("ï¼Œ").replace(/ï¼Œï¼ˆ/g, "ï¼ˆ")}ã€‚`;
        }

        function renderPreview(data) {
          preview.innerHTML = "";
          const title = document.createElement("h3");
          title.textContent = "ä¸€å¥è¯åæ§½";
          const sentence = document.createElement("p");
          sentence.textContent = buildSentence(data);
          preview.appendChild(title);
          preview.appendChild(sentence);
        }

        function getDetailPrompts(problemText) {
          const text = (problemText || "").trim();
          const impactPrompts = [
            "è¿™ä¸ªé—®é¢˜è®©ä½ é”™è¿‡æˆ–å»¶è¯¯äº†ä»€ä¹ˆï¼Ÿ",
            "å®ƒå¯¼è‡´ä½ æ— æ³•å®Œæˆå“ªäº›å…·ä½“æ“ä½œï¼Ÿ",
          ];
          const wishPrompts = [
            "ä½ å¸Œæœ›å¢åŠ å“ªäº›æ–‡å­—æˆ–è§†è§‰æç¤ºï¼Ÿ",
            "å¸Œæœ›æä¾›å“ªäº›æ›¿ä»£æ²Ÿé€šæ–¹å¼ï¼Ÿ",
          ];
          if (/è¯­éŸ³|å«å·|æ’­æŠ¥|å¹¿æ’­|å–Š/.test(text)) {
            wishPrompts.unshift("å¸Œæœ›è¯­éŸ³ä¿¡æ¯å¦‚ä½•åŒæ­¥ï¼ˆå­—å¹•/çŸ­ä¿¡/éœ‡åŠ¨ç­‰ï¼‰ï¼Ÿ");
          }
          if (/æ’é˜Ÿ|çª—å£|æŸœå°|ç°åœº|å¤§å…|æœåŠ¡å°/.test(text)) {
            impactPrompts.unshift("æ˜¯å¦å½±å“æ’é˜Ÿ/åŠç†æ—¶æœºï¼Ÿ");
          }
          if (/æ²¡æœ‰æç¤º|æœªæç¤º|ç¼ºå°‘æç¤º|æç¤ºä¸è¶³|çœ‹ä¸è§/.test(text)) {
            wishPrompts.unshift("å¸Œæœ›å“ªäº›å…³é”®ä¿¡æ¯è¢«æ–‡å­—åŒ–/å¯è§†åŒ–ï¼Ÿ");
          }
          return {
            impact: impactPrompts.slice(0, 3),
            wish: wishPrompts.slice(0, 3),
          };
        }

        function buildAutoText(key) {
          return detailAnswers[key]
            .map((value) => value.trim())
            .filter(Boolean)
            .join("ï¼›");
        }

        function applyAutoFill(key) {
          const field = key === "impact" ? impact : wish;
          const nextValue = buildAutoText(key);
          const current = field.value.trim();
          const last = autoFillCache[key];
          if (!nextValue) {
            if (!current || current === last) {
              field.value = "";
              autoFillCache[key] = "";
            }
            return;
          }
          if (current && current !== last) return;
          field.value = nextValue;
          autoFillCache[key] = nextValue;
        }

        function renderMissing(requiredMissing, optionalMissing) {
          if (requiredMissing.length === 0 && optionalMissing.length === 0) {
            missingPanel.hidden = true;
            missingPanel.innerHTML = "";
            return;
          }
          missingPanel.hidden = false;
          missingPanel.innerHTML = "";

          const heading = document.createElement("strong");
          heading.textContent =
            requiredMissing.length > 0
              ? "ç¼ºå°‘å…³é”®ä¿¡æ¯ï¼Œè¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š"
              : "å¯é€‰è¡¥å……ï¼Œè®©åæ§½æ›´å®Œæ•´ï¼š";
          missingPanel.appendChild(heading);

          const problemText = problem.value.trim();
          const needDetail =
            problemText &&
            (optionalMissing.includes("impact") ||
              optionalMissing.includes("wish"));
          if (problemText && problemText !== lastProblemSeed) {
            lastProblemSeed = problemText;
            detailAnswers.impact = [];
            detailAnswers.wish = [];
            autoFillCache.impact = "";
            autoFillCache.wish = "";
          }

          const appendQuestion = (key, isOptional = false) => {
            const wrap = document.createElement("div");
            wrap.className = "question";
            const label = document.createElement("label");
            label.textContent = `${questionMap[key]}${isOptional ? "ï¼ˆå¯é€‰ï¼‰" : ""}`;
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "è¾“å…¥åä¼šè‡ªåŠ¨è¡¥å…¨";
            input.addEventListener("input", () => {
              const value = input.value.trim();
              if (!value) return;
              if (key === "subject") subject.value = value;
              if (key === "scene") scene.value = value;
              if (key === "problem") problem.value = value;
              if (key === "impact") impact.value = value;
              if (key === "wish") wish.value = value;
              updateProgress();
              const data = collectData();
              renderPreview(data);
            });
            wrap.appendChild(label);
            wrap.appendChild(input);
            missingPanel.appendChild(wrap);
          };

          const appendDetailQuestions = (key, prompts) => {
            const title = document.createElement("div");
            title.className = "question";
            const strong = document.createElement("strong");
            strong.textContent = `ä¸ºè¡¥å…¨ã€Œ${detailLabelMap[key]}ã€è¯·å›ç­”ï¼š`;
            title.appendChild(strong);
            missingPanel.appendChild(title);

            const nextPrompts = prompts || [];
            detailAnswers[key] = detailAnswers[key].slice(
              0,
              nextPrompts.length,
            );

            nextPrompts.forEach((prompt, index) => {
              const wrap = document.createElement("div");
              wrap.className = "question";
              const label = document.createElement("label");
              label.textContent = prompt;
              const input = document.createElement("input");
              input.type = "text";
              input.placeholder = `å›ç­”åä¼šè‡ªåŠ¨è¡¥å…¨åˆ°ã€Œ${detailLabelMap[key]}ã€`;
              input.value = detailAnswers[key][index] || "";
              input.addEventListener("input", () => {
                detailAnswers[key][index] = input.value || "";
                applyAutoFill(key);
                const data = collectData();
                renderPreview(data);
              });
              wrap.appendChild(label);
              wrap.appendChild(input);
              missingPanel.appendChild(wrap);
            });

            applyAutoFill(key);
          };

          requiredMissing.forEach((key) => appendQuestion(key, false));
          if (needDetail) {
            const prompts = getDetailPrompts(problemText);
            if (optionalMissing.includes("impact"))
              appendDetailQuestions("impact", prompts.impact);
            if (optionalMissing.includes("wish"))
              appendDetailQuestions("wish", prompts.wish);
            optionalMissing
              .filter((key) => key !== "impact" && key !== "wish")
              .forEach((key) => appendQuestion(key, true));
          } else {
            optionalMissing.forEach((key) => appendQuestion(key, true));
          }
        }

        function buildCard() {
          const data = collectData();
          const requiredMissing = [];
          const optionalMissing = [];
          if (!data.subject) requiredMissing.push("subject");
          if (!data.problem) requiredMissing.push("problem");
          if (!data.scene) optionalMissing.push("scene");
          if (!data.impact) optionalMissing.push("impact");
          if (!data.wish) optionalMissing.push("wish");

          renderPreview(data);
          renderMissing(requiredMissing, optionalMissing);
          updateProgress();

          if (requiredMissing.length > 0) {
            setStatus("è¿˜ç¼ºå°‘å…³é”®å†…å®¹ï¼Œè¯·å…ˆè¡¥å…¨å†ç”Ÿæˆä¸€å¥è¯åæ§½ã€‚", "warn");
            saveBtn.disabled = true;
            return;
          }

          setStatus("ä¸€å¥è¯åæ§½å·²ç”Ÿæˆï¼Œå¯æäº¤ã€‚", "info");
          saveBtn.disabled = false;
        }

        chips.forEach((chip) => {
          chip.addEventListener("click", () => {
            const name = chip.textContent.trim();
            const selected = chip.getAttribute("aria-pressed") === "true";
            chip.setAttribute("aria-pressed", String(!selected));
            if (selected) state.categories.delete(name);
            else state.categories.add(name);
          });
        });

        toggleButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const type = btn.dataset.toggle;
            const pressed = btn.getAttribute("aria-pressed") === "true";
            btn.setAttribute("aria-pressed", String(!pressed));
            if (type === "contrast")
              document.body.classList.toggle("contrast", !pressed);
          });
        });

        fontSize.addEventListener("input", () => {
          document.documentElement.style.fontSize = `${fontSize.value}%`;
        });

        bgTheme.addEventListener("change", () => {
          applyTheme(bgTheme.value);
          localStorage.setItem(themeKey, bgTheme.value);
        });

        [subject, scene, problem, impact, wish].forEach((input) =>
          input.addEventListener("input", updateProgress),
        );
        emotion.addEventListener("input", updateEmotionLabel);

        buildBtn.addEventListener("click", buildCard);

        saveBtn.addEventListener("click", async () => {
          buildCard();
          const data = collectData();
          if (!data.subject || !data.problem) return;
          saveBtn.disabled = true;
          setStatus("æ­£åœ¨æäº¤åˆ°æœåŠ¡å™¨â€¦", "info");
          const payload = {
            ...data,
            sentence: buildSentence(data),
            created_at: new Date().toISOString(),
            mode: "hearing",
          };
          const result = await postComplaint(payload);
          if (result.ok) {
            setStatus("æäº¤æˆåŠŸï¼Œå·²ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚", "info");
            resetForm();
            return;
          }
          setStatus(`æäº¤å¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`, "warn");
          saveBtn.disabled = false;
        });

        function resetForm() {
          state.categories.clear();
          chips.forEach((chip) => chip.setAttribute("aria-pressed", "false"));
          missingPanel.hidden = true;
          missingPanel.innerHTML = "";
          detailAnswers.impact = [];
          detailAnswers.wish = [];
          autoFillCache.impact = "";
          autoFillCache.wish = "";
          lastProblemSeed = "";
          preview.innerHTML = "<p>å¡«å†™åä¼šç”Ÿæˆä¸€å¥è¯åæ§½ï¼Œæ–¹ä¾¿ç›´æ¥æäº¤ã€‚</p>";
          saveBtn.disabled = true;
          updateProgress();
          updateEmotionLabel();
          setStatus("å†…å®¹å·²æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¡«å†™ã€‚", "info");
        }

        form.addEventListener("reset", resetForm);

        // åˆå§‹åŒ–
        updateEmotionLabel();
        updateProgress();
        const savedTheme = localStorage.getItem(themeKey);
        if (savedTheme && themeMap[savedTheme]) {
          bgTheme.value = savedTheme;
          applyTheme(savedTheme);
        } else {
          applyTheme(bgTheme.value);
        }
      }
    </script>

    <script>
      // --- 3. è§†éšœæ¨¡å¼ä¸šåŠ¡é€»è¾‘ (API / Voice / File) ---
      // ç§»æ¤è‡ª "åæ§½è§†éšœ.html"

      // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognitionInstance = null;
      let activeVoiceTarget = null;
      let isListening = false;

      function ensureRecognition() {
        if (!SpeechRecognition) {
          alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ã€‚");
          return null;
        }
        if (recognitionInstance) return recognitionInstance;

        const recognition = new SpeechRecognition();
        recognition.lang = "zh-CN";
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onstart = () => {
          isListening = true;
        };
        recognition.onend = () => {
          isListening = false;
        };
        recognition.onerror = () => {
          isListening = false;
        };

        recognition.onresult = (event) => {
          const transcript = Array.from(event.results)
            .map((result) => result[0].transcript)
            .join("")
            .trim();
          if (!transcript) return;

          if (activeVoiceTarget === "__vision_help__") {
            if (typeof window.__visionHelpCommit === "function") {
              window.__visionHelpCommit(transcript);
            }
            return;
          }

          const field = document.getElementById(activeVoiceTarget);
          if (!field) return;

          const current = (field.value || "").trim();
          field.value = current ? `${current} ${transcript}` : transcript;
          field.focus();
          field.dispatchEvent(new Event("input", { bubbles: true }));
        };

        recognitionInstance = recognition;
        return recognitionInstance;
      }

      function startVoiceInput(targetId) {
        if (isListening) return;
        const recognition = ensureRecognition();
        if (!recognition) return;
        activeVoiceTarget = targetId;
        recognition.start();
      }

      function initVisionMode() {
        if (window.visionInitialized) return;
        window.visionInitialized = true;

        const submitBtn = document.getElementById("v-submitBtn");
        const statusEl = document.getElementById("v-status");
        const helpPanel = document.getElementById("visionHelp");
        const promptBox = document.getElementById("visionPromptBox");
        const helpMic = document.getElementById("visionHelpMic");
        let activeHelpKey = "";

        const state = {
          scene: "",
          severity: "",
          summary: "",
          detail: "",
          contact: "",
        };

        function setStatus(message) {
          if (statusEl) statusEl.textContent = message;
        }

        const questionMap = {
          summary: "ä¸€å¥è¯æè¿°ï¼ˆå¿…å¡«ï¼‰",
          detail: "è¯¦ç»†æè¿°ï¼ˆå¿…å¡«ï¼‰",
          scene: "å‘ç”Ÿåœºæ™¯ï¼ˆå¯é€‰ï¼‰",
          severity: "å½±å“ç¨‹åº¦ï¼ˆå¯é€‰ï¼‰",
          contact: "è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰",
        };

        function getDetailPrompts(text) {
          const prompts = [
            "å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ",
            "ä½ å°è¯•äº†å“ªäº›æ“ä½œï¼Ÿ",
            "å“ªé‡Œå¡ä½äº†ï¼Ÿ",
          ];
          if (/è¯»å±|å±å¹•|çœ‹ä¸è§|æœ—è¯»/.test(text)) {
            prompts.unshift("è¯»å±å…·ä½“è¯»å‡ºäº†ä»€ä¹ˆï¼Ÿå“ªäº›ä¿¡æ¯ç¼ºå¤±ï¼Ÿ");
          }
          if (/æŒ‰é’®|è¡¨å•|éªŒè¯ç |è´­ç¥¨|æ”¯ä»˜/.test(text)) {
            prompts.unshift("å…·ä½“å¡åœ¨å“ªä¸€æ­¥ï¼Ÿ");
          }
          return prompts.slice(0, 3);
        }

        function formatStatePreview() {
          const lines = [];
          if (state.summary.trim())
            lines.push(`å·²è®°å½•Â·ä¸€å¥è¯ï¼š${state.summary.trim()}`);
          if (state.detail.trim())
            lines.push(`å·²è®°å½•Â·è¯¦ç»†ï¼š${state.detail.trim()}`);
          if (state.scene.trim())
            lines.push(`å·²è®°å½•Â·åœºæ™¯ï¼š${state.scene.trim()}`);
          if (state.severity.trim())
            lines.push(`å·²è®°å½•Â·å½±å“ï¼š${state.severity.trim()}`);
          if (state.contact.trim())
            lines.push(`å·²è®°å½•Â·è”ç³»æ–¹å¼ï¼š${state.contact.trim()}`);
          return lines.join("\n");
        }

        function renderHelp(requiredMissing, optionalMissing) {
          if (!helpPanel || !promptBox) return;
          helpPanel.hidden = false;

          if (requiredMissing.length === 0 && optionalMissing.length === 0) {
            activeHelpKey = "";
            const preview = formatStatePreview();
            promptBox.value = [preview, "ä¿¡æ¯å·²å®Œæ•´ï¼Œå¯ä»¥æäº¤æˆ–ç»§ç»­è¡¥å……ç»†èŠ‚ã€‚"]
              .filter(Boolean)
              .join("\n\n");
            return;
          }

          const queue = [...requiredMissing, ...optionalMissing];
          activeHelpKey = queue[0] || "";

          let promptLine = questionMap[activeHelpKey] || "è¯·è¡¥å……ä¿¡æ¯";
          if (activeHelpKey === "detail") {
            const prompts = getDetailPrompts(
              state.detail.trim() || state.summary.trim(),
            );
            if (prompts.length) promptLine = prompts[0];
          }
          const preview = formatStatePreview();
          promptBox.value = [preview, `è¯·è¡¥å……ï¼š${promptLine}`]
            .filter(Boolean)
            .join("\n\n");
        }

        function updateHelp() {
          const requiredMissing = [];
          const optionalMissing = [];
          if (!state.summary.trim()) requiredMissing.push("summary");
          if (!state.detail.trim()) requiredMissing.push("detail");
          if (!state.scene.trim()) optionalMissing.push("scene");
          if (!state.severity.trim()) optionalMissing.push("severity");
          if (!state.contact.trim()) optionalMissing.push("contact");
          renderHelp(requiredMissing, optionalMissing);
        }

        function commitHelpAnswer(value) {
          const normalized = (value || "").trim();
          if (!normalized) return;
          const targetKey =
            activeHelpKey || (state.summary.trim() ? "detail" : "summary");
          if (targetKey === "summary") {
            state.summary = normalized;
          } else if (targetKey === "detail") {
            const current = state.detail.trim();
            state.detail = current ? `${current}ï¼›${normalized}` : normalized;
          } else if (targetKey === "scene") {
            state.scene = normalized;
          } else if (targetKey === "severity") {
            state.severity = normalized;
          } else if (targetKey === "contact") {
            state.contact = normalized;
          }
          updateHelp();
        }

        function startHelpVoice() {
          startVoiceInput("__vision_help__");
        }

        async function submitComplaint() {
          if (!state.summary.trim() || !state.detail.trim()) {
            updateHelp();
            setStatus("è¯·å…ˆè¡¥å…¨å¿…å¡«ä¿¡æ¯å†æäº¤ã€‚");
            return;
          }
          setStatus("æ­£åœ¨æäº¤åˆ°æœåŠ¡å™¨â€¦");
          try {
            const payload = {
              scene: state.scene,
              severity: state.severity,
              summary: state.summary,
              detail: state.detail,
              contact: state.contact,
              created_at: new Date().toISOString(),
              mode: "vision",
            };

            const result = await postComplaint(payload);
            if (!result.ok) {
              setStatus(`æäº¤å¤±è´¥ï¼š${result.error || "æœªçŸ¥é”™è¯¯"}`);
              return;
            }
            setStatus("æäº¤æˆåŠŸï¼Œå·²ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚");

            state.summary = "";
            state.detail = "";
            state.scene = "";
            state.severity = "";
            state.contact = "";
            updateHelp();
          } catch (err) {
            setStatus("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
          }
        }

        if (submitBtn) submitBtn.addEventListener("click", submitComplaint);
        if (helpMic) helpMic.addEventListener("click", startHelpVoice);

        window.__visionHelpCommit = commitHelpAnswer;

        updateHelp();
      }
    </script>
  </body>
</html>
