{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "C:\\Users\\Mac\\Desktop\\My work\\\u4E0A\u6D77\\\u5410\u69FD\\nothing\\.wrangler\\tmp\\deploy-z6N94g",
  "sourcesContent": ["const corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET,POST,DELETE,OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, X-API-Key\",\n  \"Access-Control-Max-Age\": \"86400\",\n};\n\nfunction json(data, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: {\n      \"Content-Type\": \"application/json; charset=utf-8\",\n      ...corsHeaders,\n    },\n  });\n}\n\nfunction normalizeCategories(input) {\n  if (Array.isArray(input)) return input;\n  if (typeof input === \"string\") {\n    try {\n      const parsed = JSON.parse(input);\n      if (Array.isArray(parsed)) return parsed;\n    } catch (e) {}\n  }\n  return [];\n}\n\nfunction toDbCategories(input) {\n  const list = normalizeCategories(input);\n  return list.length ? JSON.stringify(list) : null;\n}\n\nfunction rowToItem(row) {\n  return {\n    ...row,\n    categories: normalizeCategories(row.categories),\n  };\n}\n\nfunction getApiKey(request) {\n  const url = new URL(request.url);\n  return (\n    request.headers.get(\"X-API-Key\") ||\n    url.searchParams.get(\"key\") ||\n    \"\"\n  ).trim();\n}\n\nfunction requireKey(request, env) {\n  const required = env.API_KEY;\n  if (!required) return null;\n  const provided = getApiKey(request);\n  if (!provided || provided !== required) {\n    return json({ error: \"Unauthorized\" }, 401);\n  }\n  return null;\n}\n\nexport default {\n  async fetch(request, env) {\n    const url = new URL(request.url);\n    const { pathname } = url;\n\n    if (request.method === \"OPTIONS\") {\n      return new Response(null, { status: 204, headers: corsHeaders });\n    }\n\n    if (pathname === \"/api/health\") {\n      return json({ ok: true, time: new Date().toISOString() });\n    }\n\n    if (pathname === \"/api/admin/verify\" && request.method === \"GET\") {\n      const guard = requireKey(request, env);\n      if (guard) return guard;\n      return json({ ok: true });\n    }\n\n    if (pathname === \"/api/complaints\" && request.method === \"GET\") {\n      const { results } = await env.DB.prepare(\n        \"SELECT id, created_at, mode, subject, scene, problem, impact, wish, emotion, emotion_value, visibility, categories, severity, summary, detail, contact, attachment_name, attachment_data, sentence FROM complaints ORDER BY created_at DESC\"\n      ).all();\n      return json((results || []).map(rowToItem));\n    }\n\n    if (pathname === \"/api/complaints\" && request.method === \"POST\") {\n      let payload;\n      try {\n        payload = await request.json();\n      } catch (e) {\n        return json({ error: \"\u65E0\u6548\u7684 JSON\" }, 400);\n      }\n      if (!payload || typeof payload !== \"object\") {\n        return json({ error: \"\u65E0\u6548\u8BF7\u6C42\" }, 400);\n      }\n\n      const id = payload.id || crypto.randomUUID();\n      const createdAt = payload.created_at || new Date().toISOString();\n      const categories = toDbCategories(payload.categories);\n      const emotionValue =\n        payload.emotion_value ?? payload.emotionValue ?? null;\n\n      await env.DB.prepare(\n        \"INSERT INTO complaints (id, created_at, mode, subject, scene, problem, impact, wish, emotion, emotion_value, visibility, categories, severity, summary, detail, contact, attachment_name, attachment_data, sentence) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\"\n      )\n        .bind(\n          id,\n          createdAt,\n          payload.mode || null,\n          payload.subject || null,\n          payload.scene || null,\n          payload.problem || null,\n          payload.impact || null,\n          payload.wish || null,\n          payload.emotion || null,\n          emotionValue || null,\n          payload.visibility || null,\n          categories,\n          payload.severity || null,\n          payload.summary || null,\n          payload.detail || null,\n          payload.contact || null,\n          payload.attachment_name || null,\n          payload.attachment_data || null,\n          payload.sentence || null\n        )\n        .run();\n\n      return json(\n        rowToItem({\n          ...payload,\n          id,\n          created_at: createdAt,\n          categories,\n          emotion_value: emotionValue,\n        }),\n        201\n      );\n    }\n\n    if (pathname.startsWith(\"/api/complaints/\") && request.method === \"DELETE\") {\n      const guard = requireKey(request, env);\n      if (guard) return guard;\n      const id = decodeURIComponent(pathname.replace(\"/api/complaints/\", \"\"));\n      if (!id) return json({ error: \"\u7F3A\u5C11\u8BB0\u5F55ID\" }, 400);\n      const result = await env.DB.prepare(\n        \"DELETE FROM complaints WHERE id = ?\"\n      )\n        .bind(id)\n        .run();\n      if (!result || !result.meta || result.meta.changes === 0) {\n        return json({ error: \"\u672A\u627E\u5230\u8BE5\u8BB0\u5F55\" }, 404);\n      }\n      return json({ ok: true });\n    }\n\n    if (pathname === \"/api/complaints\" && request.method === \"DELETE\") {\n      const guard = requireKey(request, env);\n      if (guard) return guard;\n      await env.DB.prepare(\"DELETE FROM complaints\").run();\n      return json({ ok: true });\n    }\n\n    return json({ error: \"Not found\" }, 404);\n  },\n};\n"],
  "mappings": "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",
  "names": []
}
